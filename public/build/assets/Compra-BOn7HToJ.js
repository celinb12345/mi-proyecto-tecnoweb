import{d as c,q as $,H as q,A as pe,e as s,a as t,f as x,l as g,v as M,n as i,t as r,K as V,F as E,i as P,k as J,h,L as S,o as d}from"./app-DZXOPLfm.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const be={class:"grid grid-cols-3 gap-4 mb-6"},me={class:"flex items-end gap-2"},ve=["value"],ge=["value"],ye={class:"col-span-2"},xe=["value"],fe={class:"col-span-2 flex justify-end gap-2"},_e={type:"submit",class:"btn-green"},ke={key:0,class:"overflow-x-auto mb-8"},he={class:"w-full border border-gray-200 rounded-lg text-sm text-center"},we={class:"px-2 py-2"},Ce={class:"px-2 py-2"},Me={class:"px-2 py-2"},Ee={class:"px-2 py-2"},Pe={class:"px-2 py-2"},Se={class:"px-2 py-2"},De={class:"px-2 py-2 flex gap-2 justify-center"},Fe=["onClick"],Ne=["onClick"],Ve=["onClick"],Ue={key:0},Te={key:0,class:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-3 text-xs md:text-sm"},Be={class:"flex flex-wrap items-center gap-1"},Le=["disabled"],$e=["onClick"],Ae=["disabled"],je={key:1,class:"mt-6 border-t pt-4 space-y-4"},qe={class:"flex items-center justify-between mb-2"},ze={class:"text-lg font-semibold text-blue-500"},He={class:"text-sm"},Ie={class:"col-span-2"},Oe=["value"],Re=["value"],Qe={class:"overflow-x-auto"},Ge={class:"w-full text-xs md:text-sm border border-gray-300"},Je={class:"border px-2 py-1"},Ke={class:"border px-2 py-1 text-center"},We={class:"border px-2 py-1 text-right"},Xe={class:"border px-2 py-1 text-right"},Ye={key:0},Ze={key:0},et={class:"bg-gray-100 font-semibold"},tt={class:"border px-2 py-1 text-right"},v="rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-400 focus:outline-none transition-colors duration-200",ot={__name:"Compra",props:{darkMode:{type:Boolean,default:!1},fontClass:{type:String,default:"font-sans"}},setup(K){const n=K,y=c([]),z=c([]),H=c([]),w=c(!1),_=c(!1),I=c(null),U=c(""),T=c(""),l=c({id_compra:"",fecha_compra:"",total_compra:"",metodo_pago_comp:"",estado_compra:"",observacion_comp:"",id_proveedor:"",id_proyecto:""}),D=c(!1),p=c(null),f=c([]),F=c([]),u=c({id_compra:"",id_producto:"",cantidad:1,precio_unitario:0,subtotal:0}),B=$(()=>f.value.reduce((a,e)=>a+Number(e.subtotal||0),0));q(()=>[u.value.cantidad,u.value.precio_unitario],()=>{const a=Number(u.value.cantidad||0),e=Number(u.value.precio_unitario||0);u.value.subtotal=a*e}),q(B,a=>{p.value&&l.value.id_compra===p.value.id_compra&&(l.value.total_compra=a)});const m=c(1),N=c(5),k=$(()=>y.value.length?Math.ceil(y.value.length/N.value):1),W=$(()=>{const a=(m.value-1)*N.value;return y.value.slice(a,a+N.value)}),O=$(()=>{if(!y.value.length)return{from:0,to:0};const a=(m.value-1)*N.value+1,e=Math.min(m.value*N.value,y.value.length);return{from:a,to:e}});q(y,()=>{m.value>k.value&&(m.value=k.value)});function X(a){a>=1&&a<=k.value&&(m.value=a)}function Y(){m.value>1&&m.value--}function Z(){m.value<k.value&&m.value++}function R(a){return a?new Date(a).toLocaleDateString("es-BO",{year:"numeric",month:"2-digit",day:"2-digit"}):""}pe(()=>{C()});function ee(a={}){return S.get("propietario/melamina/compras",{params:a}).then(e=>{y.value=e.data.compras||[],z.value=e.data.proveedores||[],H.value=e.data.proyectos||[],m.value=1}).catch(e=>{console.error("Error al obtener compras",e.response?.data||e),alert("Error al obtener compras")})}function C(){const a={};return U.value&&(a.desde=U.value),T.value&&(a.hasta=T.value),ee(a).then(()=>{w.value=!0})}function te(){w.value=!w.value,w.value&&C()}function oe(){const a={...l.value};a.id_proyecto||(a.id_proyecto=null);const e=_.value?`propietario/melamina/compras/${I.value}`:"propietario/melamina/compras";S.post(e,a).then(o=>{if(!o.data||!o.data.success){console.error("Respuesta inesperada al guardar compra",o.data),alert("Error al guardar compra");return}alert(_.value?"Compra actualizada":"Compra registrada");try{o.data.compra&&o.data.compra.estado_compra==="Completada"?C().then(()=>{const b=y.value.find(L=>L.id_compra===o.data.compra.id_compra);b&&G(b)}).catch(b=>{console.error("Error al recargar compras / abrir detalle",b.response?.data||b)}):(Q(),C())}catch(b){console.error("Error posterior al guardado (JS)",b)}}).catch(o=>{console.error("Error HTTP al guardar compra",o.response?.data||o),alert("Error al guardar compra")})}function ae(a){_.value=!0,I.value=a.id_compra,l.value={...a}}function re(){_.value=!1,Q()}function le(a){confirm("Â¿Eliminar esta compra?")&&S.delete(`propietario/melamina/compras/${a}`).then(()=>{alert("Compra eliminada"),C()}).catch(e=>{console.error("Error al eliminar compra",e.response?.data||e),alert("Error al eliminar compra")})}function Q(){l.value={id_compra:"",fecha_compra:"",total_compra:"",metodo_pago_comp:"",estado_compra:"",observacion_comp:"",id_proveedor:"",id_proyecto:""},_.value=!1,j()}function A(){u.value={id_compra:p.value?p.value.id_compra:"",id_producto:"",cantidad:1,precio_unitario:0,subtotal:0}}function se(){return S.get("propietario/melamina/productos").then(a=>{F.value=a.data.productos||[]}).catch(a=>{console.error("Error al cargar productos",a.response?.data||a),F.value=[]})}function de(a){return S.get(`propietario/melamina/compras/${a}/detalles`).then(e=>{f.value=e.data.detalles||[]}).catch(e=>{console.error("Error al cargar detalles",e.response?.data||e),f.value=[]})}function G(a){if(p.value&&p.value.id_compra===a.id_compra&&D.value){j();return}p.value=a,D.value=!0,l.value.id_compra=a.id_compra,l.value.total_compra=a.total_compra,A(),se(),de(a.id_compra)}function j(){D.value=!1,p.value=null,f.value=[],A()}function ne(){if(!u.value.id_producto)return;const a=F.value.find(e=>e.id_producto===u.value.id_producto);a&&(u.value.precio_unitario=Number(a.precio_unitario_prod||0))}async function ue(){if(!p.value)return;const a={id_compra:p.value.id_compra,id_producto:u.value.id_producto,cantidad:u.value.cantidad,precio_unitario:u.value.precio_unitario,subtotal:u.value.subtotal};try{const{data:e}=await S.post("propietario/melamina/compras/detalles",a),o=e.detalle||a;o._tmpId=Date.now();const b=F.value.find(ie=>ie.id_producto===a.id_producto);b&&(o.producto=b,o.nombre_prod=b.nombre_prod),f.value.push(o);const L=B.value;p.value.total_compra=L,l.value.id_compra===p.value.id_compra&&(l.value.total_compra=L),A()}catch(e){console.error("Error al agregar detalle de compra",e.response?.data||e),alert("Error al agregar detalle de compra")}}return(a,e)=>(d(),s("div",{class:i(["p-8 rounded-2xl shadow-md transition-colors duration-300",n.darkMode?"bg-gray-800 text-gray-100":"bg-white text-gray-900",n.fontClass])},[e[41]||(e[41]=t("h2",{class:"text-2xl font-bold text-blue-500 mb-6"},"GestiÃ³n de Compras",-1)),t("div",be,[t("div",null,[e[11]||(e[11]=t("label",{class:"block text-sm font-semibold mb-1"},"Desde",-1)),g(t("input",{type:"date","onUpdate:modelValue":e[0]||(e[0]=o=>U.value=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},null,2),[[M,U.value]])]),t("div",null,[e[12]||(e[12]=t("label",{class:"block text-sm font-semibold mb-1"},"Hasta",-1)),g(t("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=o=>T.value=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},null,2),[[M,T.value]])]),t("div",me,[t("button",{onClick:C,class:"btn-blue w-full"},"Buscar"),t("button",{onClick:te,class:"btn-gray w-full"},r(w.value?"Ocultar Lista":"Listar"),1)])]),t("form",{onSubmit:J(oe,["prevent"]),class:"grid grid-cols-2 gap-4 mb-6"},[t("div",null,[e[13]||(e[13]=t("label",{class:"block text-sm font-semibold mb-1"},"Fecha",-1)),g(t("input",{type:"date","onUpdate:modelValue":e[2]||(e[2]=o=>l.value.fecha_compra=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},null,2),[[M,l.value.fecha_compra]])]),t("div",null,[e[15]||(e[15]=t("label",{class:"block text-sm font-semibold mb-1"},"Proveedor",-1)),g(t("select",{"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.id_proveedor=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},[e[14]||(e[14]=t("option",{disabled:"",value:""},"Seleccione un proveedor",-1)),(d(!0),s(E,null,P(z.value,o=>(d(),s("option",{key:o.id_proveedor,value:o.id_proveedor},r(o.nombre_empres_prov),9,ve))),128))],2),[[V,l.value.id_proveedor]])]),t("div",null,[e[17]||(e[17]=t("label",{class:"block text-sm font-semibold mb-1"},"Proyecto",-1)),g(t("select",{"onUpdate:modelValue":e[4]||(e[4]=o=>l.value.id_proyecto=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},[e[16]||(e[16]=t("option",{value:""},"Sin proyecto",-1)),(d(!0),s(E,null,P(H.value,o=>(d(),s("option",{key:o.id_proyecto,value:o.id_proyecto},r(o.nombre_pro),9,ge))),128))],2),[[V,l.value.id_proyecto]])]),t("div",null,[e[19]||(e[19]=t("label",{class:"block text-sm font-semibold mb-1"},"MÃ©todo de Pago",-1)),g(t("select",{"onUpdate:modelValue":e[5]||(e[5]=o=>l.value.metodo_pago_comp=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},[...e[18]||(e[18]=[t("option",{disabled:"",value:""},"Seleccione",-1),t("option",{value:"Efectivo"},"Efectivo",-1),t("option",{value:"QR"},"QR",-1)])],2),[[V,l.value.metodo_pago_comp]])]),t("div",null,[e[21]||(e[21]=t("label",{class:"block text-sm font-semibold mb-1"},"Estado",-1)),g(t("select",{"onUpdate:modelValue":e[6]||(e[6]=o=>l.value.estado_compra=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},[...e[20]||(e[20]=[t("option",{disabled:"",value:""},"Seleccione",-1),t("option",{value:"Pendiente"},"Pendiente",-1),t("option",{value:"Completada"},"Completada",-1),t("option",{value:"Anulada"},"Anulada",-1)])],2),[[V,l.value.estado_compra]])]),t("div",ye,[e[22]||(e[22]=t("label",{class:"block text-sm font-semibold mb-1"},"ObservaciÃ³n",-1)),g(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=o=>l.value.observacion_comp=o),rows:"2",class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100 placeholder-gray-400":"bg-white border-gray-300 text-gray-900 placeholder-gray-400"])},null,2),[[M,l.value.observacion_comp]])]),t("div",null,[e[23]||(e[23]=t("label",{class:"block text-sm font-semibold mb-1"},"Total compra",-1)),t("input",{type:"text",class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-gray-100 border-gray-300 text-gray-900"]),value:Number(l.value.total_compra||0).toFixed(2),readonly:""},null,10,xe)]),t("div",fe,[t("button",_e,r(_.value?"Actualizar":"Registrar"),1),_.value?(d(),s("button",{key:0,type:"button",onClick:re,class:"btn-gray"}," Cancelar ")):x("",!0)])],32),w.value?(d(),s("div",ke,[t("table",he,[e[24]||(e[24]=t("thead",{class:"bg-blue-600 text-white"},[t("tr",null,[t("th",{class:"px-2 py-2 border border-blue-500/60"},"Fecha"),t("th",{class:"px-2 py-2 border border-blue-500/60"},"Proveedor"),t("th",{class:"px-2 py-2 border border-blue-500/60"},"Proyecto"),t("th",{class:"px-2 py-2 border border-blue-500/60"},"Total"),t("th",{class:"px-2 py-2 border border-blue-500/60"},"MÃ©todo"),t("th",{class:"px-2 py-2 border border-blue-500/60"},"Estado"),t("th",{class:"px-2 py-2 border border-blue-500/60"},"Acciones")])],-1)),t("tbody",null,[(d(!0),s(E,null,P(W.value,o=>(d(),s("tr",{key:o.id_compra,class:i(n.darkMode?"border-b border-gray-700 hover:bg-gray-700":"border-b hover:bg-gray-50")},[t("td",we,r(R(o.fecha_compra)),1),t("td",Ce,r(o.proveedor?.nombre_empres_prov),1),t("td",Me,r(o.proyecto?.nombre_pro||"â€”"),1),t("td",Ee," S/ "+r(Number(o.total_compra||0).toFixed(2)),1),t("td",Pe,r(o.metodo_pago_comp),1),t("td",Se,r(o.estado_compra),1),t("td",De,[t("button",{onClick:b=>ae(o),class:"px-3 py-1 rounded-full text-xs font-semibold text-white bg-blue-600 hover:bg-blue-700"}," âœï¸ Editar ",8,Fe),o.estado_compra!=="Completada"?(d(),s("button",{key:0,onClick:b=>le(o.id_compra),class:"px-3 py-1 rounded-full text-xs font-semibold text-white bg-red-600 hover:bg-red-700"}," ðŸ—‘ Eliminar ",8,Ne)):x("",!0),o.estado_compra==="Completada"?(d(),s("button",{key:1,onClick:b=>G(o),class:"px-3 py-1 rounded-full text-xs font-semibold text-white bg-emerald-600 hover:bg-emerald-700"},r(p.value&&p.value.id_compra===o.id_compra&&D.value?"Ocultar detalle":"Detalle compra"),9,Ve)):x("",!0)])],2))),128)),y.value.length?x("",!0):(d(),s("tr",Ue,[t("td",{colspan:"7",class:i(["text-center py-3",n.darkMode?"text-gray-300":"text-gray-500"])}," No hay compras en el rango seleccionado ",2)]))])]),k.value>1?(d(),s("div",Te,[t("div",null,[e[25]||(e[25]=h(" Mostrando ",-1)),t("b",null,r(O.value.from),1),e[26]||(e[26]=h(" - ",-1)),t("b",null,r(O.value.to),1),e[27]||(e[27]=h(" de ",-1)),t("b",null,r(y.value.length),1),e[28]||(e[28]=h(" compras ",-1))]),t("div",Be,[t("button",{class:i(["px-2 py-1 rounded border",n.darkMode?"bg-gray-800 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-700"]),onClick:Y,disabled:m.value===1}," â¬… ",10,Le),(d(!0),s(E,null,P(k.value,o=>(d(),s("button",{key:o,class:i(["px-2 py-1 rounded border text-xs",[o===m.value?"bg-blue-600 text-white border-blue-500":n.darkMode?"bg-gray-800 text-gray-100 border-gray-600 hover:bg-gray-700":"bg-white text-gray-700 border-gray-300 hover:bg-gray-100"]]),onClick:b=>X(o)},r(o),11,$e))),128)),t("button",{class:i(["px-2 py-1 rounded border",n.darkMode?"bg-gray-800 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-700"]),onClick:Z,disabled:m.value===k.value}," âž¡ ",10,Ae)])])):x("",!0)])):x("",!0),D.value&&p.value?(d(),s("div",je,[t("div",qe,[t("h3",ze," Detalle de compra #"+r(p.value.id_compra),1),t("button",{class:"btn-gray",onClick:j}," Cerrar detalle ")]),t("p",He,[e[29]||(e[29]=t("b",null,"Proveedor:",-1)),h(" "+r(p.value.proveedor?.nombre_empres_prov||"â€”")+" Â· ",1),e[30]||(e[30]=t("b",null,"Fecha:",-1)),h(" "+r(R(p.value.fecha_compra))+" Â· ",1),e[31]||(e[31]=t("b",null,"Total actual:",-1)),h(" S/ "+r(Number(B.value||0).toFixed(2)),1)]),t("form",{class:"grid grid-cols-4 gap-4 items-end",onSubmit:J(ue,["prevent"])},[t("div",Ie,[e[33]||(e[33]=t("label",{class:"block text-xs font-semibold mb-1"},"Producto",-1)),g(t("select",{"onUpdate:modelValue":e[8]||(e[8]=o=>u.value.id_producto=o),onChange:ne,class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"]),required:""},[e[32]||(e[32]=t("option",{value:""},"Seleccione producto",-1)),(d(!0),s(E,null,P(F.value,o=>(d(),s("option",{key:o.id_producto,value:o.id_producto},r(o.nombre_prod),9,Oe))),128))],34),[[V,u.value.id_producto]])]),t("div",null,[e[34]||(e[34]=t("label",{class:"block text-xs font-semibold mb-1"},"Cantidad",-1)),g(t("input",{type:"number",min:"1",step:"1","onUpdate:modelValue":e[9]||(e[9]=o=>u.value.cantidad=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"]),required:""},null,2),[[M,u.value.cantidad,void 0,{number:!0}]])]),t("div",null,[e[35]||(e[35]=t("label",{class:"block text-xs font-semibold mb-1"}," Precio unitario ",-1)),g(t("input",{type:"number",min:"0",step:"0.01","onUpdate:modelValue":e[10]||(e[10]=o=>u.value.precio_unitario=o),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"]),required:""},null,2),[[M,u.value.precio_unitario,void 0,{number:!0}]])]),t("div",null,[e[36]||(e[36]=t("label",{class:"block text-xs font-semibold mb-1"},"Subtotal",-1)),t("input",{type:"text",value:Number(u.value.subtotal||0).toFixed(2),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-gray-100 border-gray-300 text-gray-900"]),readonly:""},null,10,Re)]),e[37]||(e[37]=t("div",{class:"col-span-4 flex justify-end"},[t("button",{type:"submit",class:"btn-green"}," âž• Agregar detalle ")],-1))],32),t("div",Qe,[t("table",Ge,[e[40]||(e[40]=t("thead",{class:"bg-gray-100"},[t("tr",null,[t("th",{class:"border px-2 py-1 text-left"},"Producto"),t("th",{class:"border px-2 py-1 text-center"},"Cantidad"),t("th",{class:"border px-2 py-1 text-right"},"Precio unitario"),t("th",{class:"border px-2 py-1 text-right"},"Subtotal")])],-1)),t("tbody",null,[(d(!0),s(E,null,P(f.value,o=>(d(),s("tr",{key:o.id_detalle_compra||o._tmpId},[t("td",Je,r(o.producto?.nombre_prod||o.nombre_prod||"â€”"),1),t("td",Ke,r(o.cantidad),1),t("td",We,r(Number(o.precio_unitario||0).toFixed(2)),1),t("td",Xe,r(Number(o.subtotal||0).toFixed(2)),1)]))),128)),f.value.length?x("",!0):(d(),s("tr",Ye,[...e[38]||(e[38]=[t("td",{colspan:"4",class:"text-center py-2 text-gray-500"}," Sin detalles registrados aÃºn. ",-1)])]))]),f.value.length?(d(),s("tfoot",Ze,[t("tr",et,[e[39]||(e[39]=t("td",{class:"border px-2 py-1 text-right",colspan:"3"}," Total detalle: ",-1)),t("td",tt,r(Number(B.value||0).toFixed(2)),1)])])):x("",!0)])])])):x("",!0)],2))}},lt=ce(ot,[["__scopeId","data-v-655554f3"]]);export{lt as default};
