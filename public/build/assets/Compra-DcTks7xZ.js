import{d as c,q as $,H as q,A as pe,e as s,a as o,f as x,l as g,v as M,n as i,t as r,K as V,F as E,i as P,k as J,h,L as S,o as d}from"./app-DZXOPLfm.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const be={class:"grid grid-cols-3 gap-4 mb-6"},me={class:"flex items-end gap-2"},ve=["value"],ge=["value"],ye={class:"col-span-2"},xe=["value"],fe={class:"col-span-2 flex justify-end gap-2"},_e={type:"submit",class:"btn-green"},ke={key:0,class:"overflow-x-auto mb-8"},he={class:"w-full border border-gray-200 rounded-lg text-sm text-center"},Ce={class:"px-2 py-2"},we={class:"px-2 py-2"},Me={class:"px-2 py-2"},Ee={class:"px-2 py-2"},Pe={class:"px-2 py-2"},Se={class:"px-2 py-2"},De={class:"px-2 py-2 flex gap-2 justify-center"},Fe=["onClick"],Ne=["onClick"],Ve=["onClick"],Ue={key:0},Te={key:0,class:"flex flex-col md:flex-row md:items-center md:justify-between gap-3 mt-3 text-xs md:text-sm"},Be={class:"flex flex-wrap items-center gap-1"},Le=["disabled"],$e=["onClick"],Ae=["disabled"],je={key:1,class:"mt-6 border-t pt-4 space-y-4"},qe={class:"flex items-center justify-between mb-2"},ze={class:"text-lg font-semibold text-blue-500"},He={class:"text-sm"},Ie={class:"col-span-2"},Oe=["value"],Re=["value"],Qe={class:"overflow-x-auto"},Ge={class:"w-full text-xs md:text-sm border border-gray-300"},Je={class:"border px-2 py-1"},Ke={class:"border px-2 py-1 text-center"},We={class:"border px-2 py-1 text-right"},Xe={class:"border px-2 py-1 text-right"},Ye={key:0},Ze={key:0},eo={class:"bg-gray-100 font-semibold"},oo={class:"border px-2 py-1 text-right"},v="rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-400 focus:outline-none transition-colors duration-200",to={__name:"Compra",props:{darkMode:{type:Boolean,default:!1},fontClass:{type:String,default:"font-sans"}},setup(K){const n=K,y=c([]),z=c([]),H=c([]),C=c(!1),_=c(!1),I=c(null),U=c(""),T=c(""),l=c({id_compra:"",fecha_compra:"",total_compra:"",metodo_pago_comp:"",estado_compra:"",observacion_comp:"",id_proveedor:"",id_proyecto:""}),D=c(!1),p=c(null),f=c([]),F=c([]),u=c({id_compra:"",id_producto:"",cantidad:1,precio_unitario:0,subtotal:0}),B=$(()=>f.value.reduce((a,e)=>a+Number(e.subtotal||0),0));q(()=>[u.value.cantidad,u.value.precio_unitario],()=>{const a=Number(u.value.cantidad||0),e=Number(u.value.precio_unitario||0);u.value.subtotal=a*e}),q(B,a=>{p.value&&l.value.id_compra===p.value.id_compra&&(l.value.total_compra=a)});const m=c(1),N=c(5),k=$(()=>y.value.length?Math.ceil(y.value.length/N.value):1),W=$(()=>{const a=(m.value-1)*N.value;return y.value.slice(a,a+N.value)}),O=$(()=>{if(!y.value.length)return{from:0,to:0};const a=(m.value-1)*N.value+1,e=Math.min(m.value*N.value,y.value.length);return{from:a,to:e}});q(y,()=>{m.value>k.value&&(m.value=k.value)});function X(a){a>=1&&a<=k.value&&(m.value=a)}function Y(){m.value>1&&m.value--}function Z(){m.value<k.value&&m.value++}function R(a){return a?new Date(a).toLocaleDateString("es-BO",{year:"numeric",month:"2-digit",day:"2-digit"}):""}pe(()=>{w()});function ee(a={}){return S.get("propietario/Construccion/compras",{params:a}).then(e=>{y.value=e.data.compras||[],z.value=e.data.proveedores||[],H.value=e.data.proyectos||[],m.value=1}).catch(e=>{console.error("Error al obtener compras",e.response?.data||e),alert("Error al obtener compras")})}function w(){const a={};return U.value&&(a.desde=U.value),T.value&&(a.hasta=T.value),ee(a).then(()=>{C.value=!0})}function oe(){C.value=!C.value,C.value&&w()}function te(){const a={...l.value};a.id_proyecto||(a.id_proyecto=null);const e=_.value?`propietario/Construccion/compras/${I.value}`:"propietario/Construccion/compras";S.post(e,a).then(t=>{if(!t.data||!t.data.success){console.error("Respuesta inesperada al guardar compra",t.data),alert("Error al guardar compra");return}alert(_.value?"Compra actualizada":"Compra registrada");try{t.data.compra&&t.data.compra.estado_compra==="Completada"?w().then(()=>{const b=y.value.find(L=>L.id_compra===t.data.compra.id_compra);b&&G(b)}).catch(b=>{console.error("Error al recargar compras / abrir detalle",b.response?.data||b)}):(Q(),w())}catch(b){console.error("Error posterior al guardado (JS)",b)}}).catch(t=>{console.error("Error HTTP al guardar compra",t.response?.data||t),alert("Error al guardar compra")})}function ae(a){_.value=!0,I.value=a.id_compra,l.value={...a}}function re(){_.value=!1,Q()}function le(a){confirm("Â¿Eliminar esta compra?")&&S.delete(`propietario/Construccion/compras/${a}`).then(()=>{alert("Compra eliminada"),w()}).catch(e=>{console.error("Error al eliminar compra",e.response?.data||e),alert("Error al eliminar compra")})}function Q(){l.value={id_compra:"",fecha_compra:"",total_compra:"",metodo_pago_comp:"",estado_compra:"",observacion_comp:"",id_proveedor:"",id_proyecto:""},_.value=!1,j()}function A(){u.value={id_compra:p.value?p.value.id_compra:"",id_producto:"",cantidad:1,precio_unitario:0,subtotal:0}}function se(){return S.get("propietario/Construccion/productos").then(a=>{F.value=a.data.productos||[]}).catch(a=>{console.error("Error al cargar productos",a.response?.data||a),F.value=[]})}function de(a){return S.get(`propietario/Construccion/compras/${a}/detalles`).then(e=>{f.value=e.data.detalles||[]}).catch(e=>{console.error("Error al cargar detalles",e.response?.data||e),f.value=[]})}function G(a){if(p.value&&p.value.id_compra===a.id_compra&&D.value){j();return}p.value=a,D.value=!0,l.value.id_compra=a.id_compra,l.value.total_compra=a.total_compra,A(),se(),de(a.id_compra)}function j(){D.value=!1,p.value=null,f.value=[],A()}function ne(){if(!u.value.id_producto)return;const a=F.value.find(e=>e.id_producto===u.value.id_producto);a&&(u.value.precio_unitario=Number(a.precio_unitario_prod||0))}async function ue(){if(!p.value)return;const a={id_compra:p.value.id_compra,id_producto:u.value.id_producto,cantidad:u.value.cantidad,precio_unitario:u.value.precio_unitario,subtotal:u.value.subtotal};try{const{data:e}=await S.post("propietario/Construccion/compras/detalles",a),t=e.detalle||a;t._tmpId=Date.now();const b=F.value.find(ie=>ie.id_producto===a.id_producto);b&&(t.producto=b,t.nombre_prod=b.nombre_prod),f.value.push(t);const L=B.value;p.value.total_compra=L,l.value.id_compra===p.value.id_compra&&(l.value.total_compra=L),A()}catch(e){console.error("Error al agregar detalle de compra",e.response?.data||e),alert("Error al agregar detalle de compra")}}return(a,e)=>(d(),s("div",{class:i(["p-8 rounded-2xl shadow-md transition-colors duration-300",n.darkMode?"bg-gray-800 text-gray-100":"bg-white text-gray-900",n.fontClass])},[e[41]||(e[41]=o("h2",{class:"text-2xl font-bold text-blue-500 mb-6"},"GestiÃ³n de Compras",-1)),o("div",be,[o("div",null,[e[11]||(e[11]=o("label",{class:"block text-sm font-semibold mb-1"},"Desde",-1)),g(o("input",{type:"date","onUpdate:modelValue":e[0]||(e[0]=t=>U.value=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},null,2),[[M,U.value]])]),o("div",null,[e[12]||(e[12]=o("label",{class:"block text-sm font-semibold mb-1"},"Hasta",-1)),g(o("input",{type:"date","onUpdate:modelValue":e[1]||(e[1]=t=>T.value=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},null,2),[[M,T.value]])]),o("div",me,[o("button",{onClick:w,class:"btn-blue w-full"},"Buscar"),o("button",{onClick:oe,class:"btn-gray w-full"},r(C.value?"Ocultar Lista":"Listar"),1)])]),o("form",{onSubmit:J(te,["prevent"]),class:"grid grid-cols-2 gap-4 mb-6"},[o("div",null,[e[13]||(e[13]=o("label",{class:"block text-sm font-semibold mb-1"},"Fecha",-1)),g(o("input",{type:"date","onUpdate:modelValue":e[2]||(e[2]=t=>l.value.fecha_compra=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},null,2),[[M,l.value.fecha_compra]])]),o("div",null,[e[15]||(e[15]=o("label",{class:"block text-sm font-semibold mb-1"},"Proveedor",-1)),g(o("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>l.value.id_proveedor=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},[e[14]||(e[14]=o("option",{disabled:"",value:""},"Seleccione un proveedor",-1)),(d(!0),s(E,null,P(z.value,t=>(d(),s("option",{key:t.id_proveedor,value:t.id_proveedor},r(t.nombre_empres_prov),9,ve))),128))],2),[[V,l.value.id_proveedor]])]),o("div",null,[e[17]||(e[17]=o("label",{class:"block text-sm font-semibold mb-1"},"Proyecto",-1)),g(o("select",{"onUpdate:modelValue":e[4]||(e[4]=t=>l.value.id_proyecto=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},[e[16]||(e[16]=o("option",{value:""},"Sin proyecto",-1)),(d(!0),s(E,null,P(H.value,t=>(d(),s("option",{key:t.id_proyecto,value:t.id_proyecto},r(t.nombre_pro),9,ge))),128))],2),[[V,l.value.id_proyecto]])]),o("div",null,[e[19]||(e[19]=o("label",{class:"block text-sm font-semibold mb-1"},"MÃ©todo de Pago",-1)),g(o("select",{"onUpdate:modelValue":e[5]||(e[5]=t=>l.value.metodo_pago_comp=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},[...e[18]||(e[18]=[o("option",{disabled:"",value:""},"Seleccione",-1),o("option",{value:"Efectivo"},"Efectivo",-1),o("option",{value:"QR"},"QR",-1)])],2),[[V,l.value.metodo_pago_comp]])]),o("div",null,[e[21]||(e[21]=o("label",{class:"block text-sm font-semibold mb-1"},"Estado",-1)),g(o("select",{"onUpdate:modelValue":e[6]||(e[6]=t=>l.value.estado_compra=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"])},[...e[20]||(e[20]=[o("option",{disabled:"",value:""},"Seleccione",-1),o("option",{value:"Pendiente"},"Pendiente",-1),o("option",{value:"Completada"},"Completada",-1),o("option",{value:"Anulada"},"Anulada",-1)])],2),[[V,l.value.estado_compra]])]),o("div",ye,[e[22]||(e[22]=o("label",{class:"block text-sm font-semibold mb-1"},"ObservaciÃ³n",-1)),g(o("textarea",{"onUpdate:modelValue":e[7]||(e[7]=t=>l.value.observacion_comp=t),rows:"2",class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100 placeholder-gray-400":"bg-white border-gray-300 text-gray-900 placeholder-gray-400"])},null,2),[[M,l.value.observacion_comp]])]),o("div",null,[e[23]||(e[23]=o("label",{class:"block text-sm font-semibold mb-1"},"Total compra",-1)),o("input",{type:"text",class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-gray-100 border-gray-300 text-gray-900"]),value:Number(l.value.total_compra||0).toFixed(2),readonly:""},null,10,xe)]),o("div",fe,[o("button",_e,r(_.value?"Actualizar":"Registrar"),1),_.value?(d(),s("button",{key:0,type:"button",onClick:re,class:"btn-gray"}," Cancelar ")):x("",!0)])],32),C.value?(d(),s("div",ke,[o("table",he,[e[24]||(e[24]=o("thead",{class:"bg-blue-600 text-white"},[o("tr",null,[o("th",{class:"px-2 py-2 border border-blue-500/60"},"Fecha"),o("th",{class:"px-2 py-2 border border-blue-500/60"},"Proveedor"),o("th",{class:"px-2 py-2 border border-blue-500/60"},"Proyecto"),o("th",{class:"px-2 py-2 border border-blue-500/60"},"Total"),o("th",{class:"px-2 py-2 border border-blue-500/60"},"MÃ©todo"),o("th",{class:"px-2 py-2 border border-blue-500/60"},"Estado"),o("th",{class:"px-2 py-2 border border-blue-500/60"},"Acciones")])],-1)),o("tbody",null,[(d(!0),s(E,null,P(W.value,t=>(d(),s("tr",{key:t.id_compra,class:i(n.darkMode?"border-b border-gray-700 hover:bg-gray-700":"border-b hover:bg-gray-50")},[o("td",Ce,r(R(t.fecha_compra)),1),o("td",we,r(t.proveedor?.nombre_empres_prov),1),o("td",Me,r(t.proyecto?.nombre_pro||"â€”"),1),o("td",Ee," S/ "+r(Number(t.total_compra||0).toFixed(2)),1),o("td",Pe,r(t.metodo_pago_comp),1),o("td",Se,r(t.estado_compra),1),o("td",De,[o("button",{onClick:b=>ae(t),class:"px-3 py-1 rounded-full text-xs font-semibold text-white bg-blue-600 hover:bg-blue-700"}," âœï¸ Editar ",8,Fe),t.estado_compra!=="Completada"?(d(),s("button",{key:0,onClick:b=>le(t.id_compra),class:"px-3 py-1 rounded-full text-xs font-semibold text-white bg-red-600 hover:bg-red-700"}," ðŸ—‘ Eliminar ",8,Ne)):x("",!0),t.estado_compra==="Completada"?(d(),s("button",{key:1,onClick:b=>G(t),class:"px-3 py-1 rounded-full text-xs font-semibold text-white bg-emerald-600 hover:bg-emerald-700"},r(p.value&&p.value.id_compra===t.id_compra&&D.value?"Ocultar detalle":"Detalle compra"),9,Ve)):x("",!0)])],2))),128)),y.value.length?x("",!0):(d(),s("tr",Ue,[o("td",{colspan:"7",class:i(["text-center py-3",n.darkMode?"text-gray-300":"text-gray-500"])}," No hay compras en el rango seleccionado ",2)]))])]),k.value>1?(d(),s("div",Te,[o("div",null,[e[25]||(e[25]=h(" Mostrando ",-1)),o("b",null,r(O.value.from),1),e[26]||(e[26]=h(" - ",-1)),o("b",null,r(O.value.to),1),e[27]||(e[27]=h(" de ",-1)),o("b",null,r(y.value.length),1),e[28]||(e[28]=h(" compras ",-1))]),o("div",Be,[o("button",{class:i(["px-2 py-1 rounded border",n.darkMode?"bg-gray-800 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-700"]),onClick:Y,disabled:m.value===1}," â¬… ",10,Le),(d(!0),s(E,null,P(k.value,t=>(d(),s("button",{key:t,class:i(["px-2 py-1 rounded border text-xs",[t===m.value?"bg-blue-600 text-white border-blue-500":n.darkMode?"bg-gray-800 text-gray-100 border-gray-600 hover:bg-gray-700":"bg-white text-gray-700 border-gray-300 hover:bg-gray-100"]]),onClick:b=>X(t)},r(t),11,$e))),128)),o("button",{class:i(["px-2 py-1 rounded border",n.darkMode?"bg-gray-800 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-700"]),onClick:Z,disabled:m.value===k.value}," âž¡ ",10,Ae)])])):x("",!0)])):x("",!0),D.value&&p.value?(d(),s("div",je,[o("div",qe,[o("h3",ze," Detalle de compra #"+r(p.value.id_compra),1),o("button",{class:"btn-gray",onClick:j}," Cerrar detalle ")]),o("p",He,[e[29]||(e[29]=o("b",null,"Proveedor:",-1)),h(" "+r(p.value.proveedor?.nombre_empres_prov||"â€”")+" Â· ",1),e[30]||(e[30]=o("b",null,"Fecha:",-1)),h(" "+r(R(p.value.fecha_compra))+" Â· ",1),e[31]||(e[31]=o("b",null,"Total actual:",-1)),h(" S/ "+r(Number(B.value||0).toFixed(2)),1)]),o("form",{class:"grid grid-cols-4 gap-4 items-end",onSubmit:J(ue,["prevent"])},[o("div",Ie,[e[33]||(e[33]=o("label",{class:"block text-xs font-semibold mb-1"},"Producto",-1)),g(o("select",{"onUpdate:modelValue":e[8]||(e[8]=t=>u.value.id_producto=t),onChange:ne,class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"]),required:""},[e[32]||(e[32]=o("option",{value:""},"Seleccione producto",-1)),(d(!0),s(E,null,P(F.value,t=>(d(),s("option",{key:t.id_producto,value:t.id_producto},r(t.nombre_prod),9,Oe))),128))],34),[[V,u.value.id_producto]])]),o("div",null,[e[34]||(e[34]=o("label",{class:"block text-xs font-semibold mb-1"},"Cantidad",-1)),g(o("input",{type:"number",min:"1",step:"1","onUpdate:modelValue":e[9]||(e[9]=t=>u.value.cantidad=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"]),required:""},null,2),[[M,u.value.cantidad,void 0,{number:!0}]])]),o("div",null,[e[35]||(e[35]=o("label",{class:"block text-xs font-semibold mb-1"}," Precio unitario ",-1)),g(o("input",{type:"number",min:"0",step:"0.01","onUpdate:modelValue":e[10]||(e[10]=t=>u.value.precio_unitario=t),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-white border-gray-300 text-gray-900"]),required:""},null,2),[[M,u.value.precio_unitario,void 0,{number:!0}]])]),o("div",null,[e[36]||(e[36]=o("label",{class:"block text-xs font-semibold mb-1"},"Subtotal",-1)),o("input",{type:"text",value:Number(u.value.subtotal||0).toFixed(2),class:i([v,n.darkMode?"bg-gray-900 border-gray-600 text-gray-100":"bg-gray-100 border-gray-300 text-gray-900"]),readonly:""},null,10,Re)]),e[37]||(e[37]=o("div",{class:"col-span-4 flex justify-end"},[o("button",{type:"submit",class:"btn-green"}," âž• Agregar detalle ")],-1))],32),o("div",Qe,[o("table",Ge,[e[40]||(e[40]=o("thead",{class:"bg-gray-100"},[o("tr",null,[o("th",{class:"border px-2 py-1 text-left"},"Producto"),o("th",{class:"border px-2 py-1 text-center"},"Cantidad"),o("th",{class:"border px-2 py-1 text-right"},"Precio unitario"),o("th",{class:"border px-2 py-1 text-right"},"Subtotal")])],-1)),o("tbody",null,[(d(!0),s(E,null,P(f.value,t=>(d(),s("tr",{key:t.id_detalle_compra||t._tmpId},[o("td",Je,r(t.producto?.nombre_prod||t.nombre_prod||"â€”"),1),o("td",Ke,r(t.cantidad),1),o("td",We,r(Number(t.precio_unitario||0).toFixed(2)),1),o("td",Xe,r(Number(t.subtotal||0).toFixed(2)),1)]))),128)),f.value.length?x("",!0):(d(),s("tr",Ye,[...e[38]||(e[38]=[o("td",{colspan:"4",class:"text-center py-2 text-gray-500"}," Sin detalles registrados aÃºn. ",-1)])]))]),f.value.length?(d(),s("tfoot",Ze,[o("tr",eo,[e[39]||(e[39]=o("td",{class:"border px-2 py-1 text-right",colspan:"3"}," Total detalle: ",-1)),o("td",oo,r(Number(B.value||0).toFixed(2)),1)])])):x("",!0)])])])):x("",!0)],2))}},lo=ce(to,[["__scopeId","data-v-47521554"]]);export{lo as default};
