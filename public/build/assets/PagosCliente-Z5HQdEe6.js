import{y as K,q as x,d as f,G as J,A as W,e as d,b as X,a as e,f as m,w as Y,o as u,n as r,t as n,T as Z,h as _,k as ee,l as y,K as A,v as h,F as I,i as O,L as B}from"./app-DZXOPLfm.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const te={class:"text-2xl"},ae={class:"font-semibold"},re={key:0,class:"text-sm mt-1"},le={class:"flex flex-col md:flex-row md:items-center md:justify-between gap-6"},se={class:"flex-1"},ne={class:"text-xl font-bold mt-1"},de={class:"flex-1"},ue={class:"text-xl font-bold mt-1"},ie={key:0},ge={key:1},pe={class:"flex-1 text-right space-y-1"},ce={class:"text-3xl font-extrabold text-green-500 mt-1"},be={key:0,class:"text-sm mt-1"},me={class:"font-semibold text-blue-400"},ye={class:"font-semibold"},ve={key:0,class:"mt-1"},xe={class:"font-bold text-red-400"},fe={class:"md:col-span-2"},_e=["disabled"],he={key:0,class:"md:col-span-2 mt-2"},we={class:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-3"},Ce={class:"flex items-end"},ke=["onUpdate:modelValue"],Pe={class:"md:col-span-2 flex justify-end mt-4"},Ne={class:"flex items-center justify-between mb-2"},Se=["onClick"],Me={class:"p-2 border-0"},De={class:"p-2 border-0"},Ve={class:"p-2 border-0"},Ee={key:0},Fe=["src"],Ue={__name:"PagosCliente",props:{darkMode:{type:Boolean,default:!1}},setup(z){const D=K(),H=z,a=x(()=>H.darkMode),w=x(()=>D.props.proyecto??null),V=x(()=>D.props.propietario??null),k=f(Number(D.props.totalPagado||0)),C=s=>Number(s||0).toLocaleString("es-BO",{style:"currency",currency:"BOB"}),E=x(()=>w.value?Number(w.value.monto_total_pro??0):0),j=x(()=>E.value-k.value),t=J({tipo_pago:"cliente",metodo_pago:"",numero_comprobante:null,concepto_pago:"",fecha_pago:"",monto_total_pago:0,enCuotas:"no",cantidadCuotas:1,primeraFecha:"",planCuotas:[]}),R=x(()=>j.value-Number(t.monto_total_pago||0)),v=f([]),p=f(null),P=f(null),F=f(null),c=f(""),i=f("");function N(){c.value="",i.value=""}const U=x(()=>{if(!v.value.length)return null;const s=new Date;s.setHours(0,0,0,0);const o=1e3*60*60*24;let l=null;for(const g of v.value){const b=new Date(g.fecha_vencimiento);if(isNaN(b))continue;b.setHours(0,0,0,0);const M=Math.round((b-s)/o);M<0||(l===null||M<l)&&(l=M)}return l});function T(){if(!v.value.length)return;const s=new Date;s.setHours(0,0,0,0);const o=1e3*60*60*24;let l=!1;for(const g of v.value){const b=new Date(g.fecha_vencimiento);if(isNaN(b))continue;if(b.setHours(0,0,0,0),Math.round((b-s)/o)===0){l=!0;break}}l&&alert("Atención: hoy vence al menos una de tus cuotas.")}function G(){if(N(),!t.cantidadCuotas||!t.primeraFecha){i.value="Debe completar número de cuotas y fecha inicial.";return}t.planCuotas=[];const s=E.value/t.cantidadCuotas,o=new Date(t.primeraFecha);for(let l=1;l<=t.cantidadCuotas;l++){const g=new Date(o);g.setMonth(g.getMonth()+(l-1)),t.planCuotas.push({numero:l,monto:Number(s.toFixed(2)),fecha:g.toISOString().slice(0,10),estado:l===1?"Pagado":"Pendiente"})}t.planCuotas.length&&(t.monto_total_pago=t.planCuotas[0].monto)}function L(s){N(),p.value=s,t.enCuotas="no",t.monto_total_pago=Number(s.monto_cuota),t.concepto_pago=`Pago cuota #${s.numero_cuota}`,t.fecha_pago=new Date().toISOString().slice(0,10)}function q(){t.monto_total_pago=0,t.concepto_pago="",t.numero_comprobante=null,t.metodo_pago="",t.enCuotas="no",t.cantidadCuotas=1,t.primeraFecha="",t.planCuotas=[],p.value=null}async function Q(){try{if(N(),!w.value){i.value="No se encontró proyecto.";return}if(!t.metodo_pago){i.value="Debe seleccionar método de pago.";return}if(!t.fecha_pago){i.value="Debe indicar la fecha de pago.";return}if(!t.monto_total_pago||t.monto_total_pago<=0){i.value="El monto del pago debe ser mayor a 0.";return}const s={id_proyecto:w.value.id_proyecto,tipo_pago:"cliente",metodo_pago:t.metodo_pago,numero_comprobante:t.numero_comprobante,concepto_pago:t.concepto_pago,fecha_pago:t.fecha_pago,monto_total_pago:t.monto_total_pago,en_cuotas:t.enCuotas==="si",plan:t.enCuotas==="si"?t.planCuotas:[],id_cuota:p.value?p.value.id_cuota:null};t.metodo_pago==="qr"&&t.enCuotas==="si"&&t.planCuotas.length&&(s.monto_total_pago=t.planCuotas[0].monto);const o=await B.post("cliente/pagos",s);if(!o.data.ok){i.value=o.data.message||"Ocurrió un error al registrar el pago.";return}if(t.metodo_pago==="qr"){const l=o.data.qr_image;P.value=l?"data:image/png;base64,"+l:null,F.value=o.data.transaction||null,c.value=o.data.message||"QR generado correctamente. Escanea el código para completar tu pago."}else c.value=o.data.message||"Pago realizado con éxito. ¡Gracias por tu pago!",k.value+=Number(t.monto_total_pago||0),await S(),q()}catch(s){console.error(s),i.value="Error al registrar el pago."}}async function $(){try{N();const s=await B.post("cliente/pagos/consultar",{codigo:F.value});if(s.data.isPaid){P.value=null,F.value=null;const o=Number(s.data.pago?.monto_total_pago||0);k.value+=o,await S(),q(),c.value="Pago realizado con éxito. ¡Gracias por tu pago!"}else i.value="Estado del pago: "+(s.data.estado||"Pendiente")}catch(s){console.error(s),i.value="Error al verificar el estado del pago."}}async function S(){const s=await B.get("cliente/pagos/cuotas-pendientes");v.value=s.data.cuotas||[],T()}return W(()=>{t.fecha_pago=new Date().toISOString().slice(0,10),S()}),(s,o)=>(u(),d("div",{class:r(["space-y-6",a.value?"text-gray-100":"text-gray-900"])},[X(Z,{name:"fade"},{default:Y(()=>[c.value||i.value?(u(),d("div",{key:0,class:r(["rounded-2xl px-4 py-3 flex items-center gap-3 shadow",c.value?a.value?"bg-green-900/40 text-green-200 border border-green-700":"bg-green-50 text-green-700 border border-green-200":a.value?"bg-red-900/40 text-red-200 border border-red-700":"bg-red-50 text-red-700 border border-red-200"])},[e("span",te,n(c.value?"✅":"⚠️"),1),e("div",null,[e("p",ae,n(c.value||"Ocurrió un problema"),1),i.value&&!c.value?(u(),d("p",re,n(i.value),1)):m("",!0)])],2)):m("",!0)]),_:1}),e("section",{class:r(["rounded-2xl shadow p-6",a.value?"bg-gray-800 text-gray-100":"bg-gray-50 text-gray-800"])},[o[14]||(o[14]=e("h2",{class:"text-3xl font-semibold text-blue-500 mb-6"}," Pagos del proyecto ",-1)),e("div",le,[e("div",se,[e("p",{class:r(["text-sm font-semibold uppercase tracking-wide",a.value?"text-gray-300":"text-gray-500"])}," Proyecto ",2),e("p",ne,n(w.value?.nombre_pro||"Sin nombre"),1),e("p",{class:r(["text-base mt-1",a.value?"text-gray-300":"text-gray-600"])},n(w.value?.descripcion_pro||"Sin descripción registrada."),3)]),e("div",de,[e("p",{class:r(["text-sm font-semibold uppercase tracking-wide",a.value?"text-gray-300":"text-gray-500"])}," Propietario ",2),e("p",ue,[V.value?(u(),d("span",ie,n(V.value.nombre_propietario)+" "+n(V.value.apellido_propietario),1)):(u(),d("span",ge,"Sin propietario"))])]),e("div",pe,[e("p",{class:r(["text-sm font-semibold uppercase tracking-wide",a.value?"text-gray-300":"text-gray-500"])}," Monto del proyecto ",2),e("p",ce,n(C(E.value)),1),U.value!==null?(u(),d("p",be,[o[8]||(o[8]=_(" Próxima cuota vence en ",-1)),e("span",{class:r(U.value<=3?"text-red-500 font-semibold":"font-semibold")},n(U.value)+" día(s) ",3)])):m("",!0),e("div",{class:r(["text-sm mt-2 space-y-1",a.value?"text-gray-200":"text-gray-700"])},[e("p",null,[o[9]||(o[9]=_(" Pagado hasta ahora: ",-1)),e("span",me,n(C(k.value)),1)]),e("p",null,[o[10]||(o[10]=_(" Saldo pendiente: ",-1)),e("span",ye,n(C(j.value)),1)]),t.monto_total_pago>0?(u(),d("p",ve,[o[11]||(o[11]=_(" Saldo ",-1)),o[12]||(o[12]=e("b",null,"después",-1)),o[13]||(o[13]=_(" de este pago: ",-1)),e("span",xe,n(C(R.value)),1)])):m("",!0)],2)])])],2),e("section",{class:r(["rounded-2xl shadow p-6",a.value?"bg-gray-800 text-gray-100":"bg-white text-gray-800"])},[o[27]||(o[27]=e("h3",{class:"text-xl font-semibold text-blue-500 mb-4"},"Registrar un pago",-1)),e("form",{onSubmit:ee(Q,["prevent"]),class:"grid grid-cols-1 md:grid-cols-2 gap-4"},[o[26]||(o[26]=e("div",null,[e("label",{class:"text-sm font-semibold mb-1 block"},"Tipo de pago"),e("input",{disabled:"",value:"Cliente / Proyecto",class:"w-full rounded-lg border px-3 py-2 bg-gray-100 text-gray-700"})],-1)),e("div",null,[o[16]||(o[16]=e("label",{class:"text-sm font-semibold mb-1 block"},"Método de pago",-1)),y(e("select",{"onUpdate:modelValue":o[0]||(o[0]=l=>t.metodo_pago=l),class:r(["w-full rounded-lg border px-3 py-2",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},[...o[15]||(o[15]=[e("option",{disabled:"",value:""},"Seleccione",-1),e("option",{value:"efectivo"},"Efectivo",-1),e("option",{value:"qr"},"QR",-1)])],2),[[A,t.metodo_pago]])]),e("div",null,[o[17]||(o[17]=e("label",{class:"text-sm font-semibold mb-1 block"},"Nº comprobante (opcional)",-1)),y(e("input",{"onUpdate:modelValue":o[1]||(o[1]=l=>t.numero_comprobante=l),type:"number",class:r(["w-full rounded-lg border px-3 py-2",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},null,2),[[h,t.numero_comprobante]])]),e("div",null,[o[18]||(o[18]=e("label",{class:"text-sm font-semibold mb-1 block"},"Fecha de pago",-1)),y(e("input",{type:"date","onUpdate:modelValue":o[2]||(o[2]=l=>t.fecha_pago=l),class:r(["w-full rounded-lg border px-3 py-2",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},null,2),[[h,t.fecha_pago]])]),e("div",fe,[o[19]||(o[19]=e("label",{class:"text-sm font-semibold mb-1 block"},"Concepto",-1)),y(e("input",{"onUpdate:modelValue":o[3]||(o[3]=l=>t.concepto_pago=l),type:"text",placeholder:"Ej: pago de cuota, pago parcial, etc.",class:r(["w-full rounded-lg border px-3 py-2",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},null,2),[[h,t.concepto_pago]])]),e("div",null,[o[21]||(o[21]=e("label",{class:"text-sm font-semibold mb-1 block"},"Monto del pago",-1)),y(e("input",{type:"number",min:"0",step:"0.01","onUpdate:modelValue":o[4]||(o[4]=l=>t.monto_total_pago=l),class:r(["w-full rounded-lg border px-3 py-2",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},null,2),[[h,t.monto_total_pago,void 0,{number:!0}]]),e("p",{class:r(["text-xs mt-1",a.value?"text-gray-400":"text-gray-500"])},[...o[20]||(o[20]=[_(" Si usas cuotas nuevas, este será el monto de la ",-1),e("b",null,"primera cuota",-1),_(". ",-1)])],2)]),e("div",null,[o[23]||(o[23]=e("label",{class:"text-sm font-semibold mb-1 block"},"¿En cuotas?",-1)),y(e("select",{"onUpdate:modelValue":o[5]||(o[5]=l=>t.enCuotas=l),disabled:!!p.value,class:r(["w-full rounded-lg border px-3 py-2",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},[...o[22]||(o[22]=[e("option",{value:"no"},"Pago directo",-1),e("option",{value:"si"},"En cuotas",-1)])],10,_e),[[A,t.enCuotas]]),p.value?(u(),d("p",{key:0,class:r(["text-[11px] mt-1",a.value?"text-gray-400":"text-gray-500"])}," Estás pagando la cuota #"+n(p.value.numero_cuota)+" (pago directo). ",3)):m("",!0)]),t.enCuotas==="si"?(u(),d("div",he,[e("fieldset",{class:r(["border p-4 rounded-xl",a.value?"border-gray-600":"border-gray-300"])},[e("legend",{class:r(["px-2 text-sm",a.value?"text-gray-300":"text-gray-600"])}," Plan de cuotas ",2),e("div",we,[e("div",null,[o[24]||(o[24]=e("label",{class:"text-sm font-semibold mb-1 block"},"Número de cuotas",-1)),y(e("input",{type:"number",min:"1","onUpdate:modelValue":o[6]||(o[6]=l=>t.cantidadCuotas=l),class:r(["w-full rounded-lg border px-3 py-2",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},null,2),[[h,t.cantidadCuotas,void 0,{number:!0}]])]),e("div",null,[o[25]||(o[25]=e("label",{class:"text-sm font-semibold mb-1 block"},"Fecha 1ª cuota",-1)),y(e("input",{type:"date","onUpdate:modelValue":o[7]||(o[7]=l=>t.primeraFecha=l),class:r(["w-full rounded-lg border px-3 py-2",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},null,2),[[h,t.primeraFecha]])]),e("div",Ce,[e("button",{type:"button",onClick:G,class:r(["w-full text-white px-4 py-2 rounded-lg",a.value?"bg-gray-600 hover:bg-gray-500":"bg-gray-700 hover:bg-gray-800"])}," Generar plan ",2)])]),t.planCuotas.length?(u(),d("table",{key:0,class:r(["w-full text-sm border mt-2",a.value?"border-gray-600":"border-gray-300"])},[e("thead",{class:r(a.value?"bg-gray-700":"bg-gray-100")},[e("tr",null,[e("th",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},"#",2),e("th",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},"Monto",2),e("th",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},"Fecha",2),e("th",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},"Estado",2)])],2),e("tbody",null,[(u(!0),d(I,null,O(t.planCuotas,(l,g)=>(u(),d("tr",{key:g},[e("td",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},n(l.numero),3),e("td",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},n(C(l.monto)),3),e("td",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},[y(e("input",{type:"date","onUpdate:modelValue":b=>l.fecha=b,class:r(["w-full border rounded-lg px-2 py-1 text-sm",a.value?"bg-gray-900 border-gray-600":"bg-white border-gray-300"])},null,10,ke),[[h,l.fecha]])],2),e("td",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},n(l.estado),3)]))),128))])],2)):m("",!0)],2)])):m("",!0),e("div",Pe,[e("button",{type:"submit",class:r(["px-8 py-3 rounded-lg font-semibold text-base text-white",a.value?"bg-green-700 hover:bg-green-600":"bg-green-600 hover:bg-green-700"])}," Registrar pago ",2)])],32)],2),e("section",{class:r(["rounded-2xl shadow p-6",a.value?"bg-gray-800 text-gray-100":"bg-white text-gray-800"])},[e("div",Ne,[o[28]||(o[28]=e("h3",{class:"text-xl font-semibold text-blue-500"},"Cuotas pendientes",-1)),e("button",{class:r(["text-sm text-white px-3 py-1 rounded-lg",a.value?"bg-yellow-600 hover:bg-yellow-500":"bg-yellow-500 hover:bg-yellow-600"]),onClick:S}," Actualizar ",2)]),e("p",{class:r(["text-[11px] mb-2",a.value?"text-gray-400":"text-gray-500"])}," Haz clic en una fila para seleccionar esa cuota y registrarla como pago directo. ",2),e("table",{class:r(["w-full text-sm border",a.value?"border-gray-600":"border-gray-300"])},[e("thead",{class:r(a.value?"bg-yellow-900/40":"bg-yellow-100")},[e("tr",null,[e("th",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},"#",2),e("th",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},"Monto",2),e("th",{class:r(["p-2 border",a.value?"border-gray-600":"border-gray-300"])},"Vencimiento",2)])],2),e("tbody",null,[(u(!0),d(I,null,O(v.value,l=>(u(),d("tr",{key:l.id_cuota,onClick:g=>L(l),class:r(["border-b cursor-pointer",a.value?"border-gray-700":"border-gray-200",p.value&&p.value.id_cuota===l.id_cuota?a.value?"bg-blue-900/40":"bg-blue-50":a.value?"hover:bg-gray-700":"hover:bg-yellow-50"])},[e("td",Me,n(l.numero_cuota),1),e("td",De,n(C(l.monto_cuota)),1),e("td",Ve,n(l.fecha_vencimiento),1)],10,Se))),128)),v.value.length?m("",!0):(u(),d("tr",Ee,[e("td",{colspan:"3",class:r(["text-center py-3",a.value?"text-gray-400":"text-gray-500"])}," No tienes cuotas pendientes. ",2)]))])],2)],2),P.value?(u(),d("section",{key:0,class:r(["rounded-2xl shadow p-6 text-center",a.value?"bg-gray-800 text-gray-100":"bg-white text-gray-800"])},[o[29]||(o[29]=e("h3",{class:"text-lg font-semibold mb-2 text-blue-500"},"Escanea el código QR para realizar tu pago",-1)),e("img",{src:P.value,class:"w-64 mx-auto shadow-lg rounded-xl p-3 bg-white"},null,8,Fe),e("button",{onClick:$,class:r(["mt-4 text-white px-4 py-2 rounded-lg",a.value?"bg-blue-600 hover:bg-blue-500":"bg-blue-600 hover:bg-blue-700"])}," Verificar pago ",2)],2)):m("",!0)],2))}},qe=oe(Ue,[["__scopeId","data-v-00ec8d82"]]);export{qe as default};
